<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		
		
		<meta name="description" content="ginolhac&#39; blog about computer stuff">
		<meta name="generator" content="Hugo 0.34" />
		<title>DIY raspberry monitored via telegram &middot; ginolhac</title>
		<link rel="shortcut icon" href="../../images/favicon.ico">
		<link rel="stylesheet" href="../../css/style.css">
		<link rel="stylesheet" href="../../css/highlight.css">

		
		<link rel="stylesheet" href="../../css/font-awesome.min.css">
		

		

		
	</head>

    <body>
       <nav class="main-nav">
	
	
		<a href='../../'> <span class="arrow">←</span>Home</a>
	
	<a href='../../posts'>Archive</a>
	<a href='../../karate'>Karate</a>
	<a href='../../tags'>Tags</a>
	<a href='../../about'>About</a>

	

	
</nav>


        <section id="wrapper" class="post">
            <article>
                <header>
                    <h1>
                        DIY raspberry monitored via telegram
                    </h1>
                    <h2 class="headline">
                    Jan 27, 2018 00:00
                    · 986 words
                    · 5 minute read
                      <span class="tags">
                      
                      
                          
                              <a href="../../tags/diy">DIY</a>
                          
                              <a href="../../tags/pi">pi</a>
                          
                      
                      
                      </span>
                    </h2>
                </header>
                
                <section id="post-body">
                    

<h2 id="rationale">Rationale</h2>

<p>The <a href="https://www.raspberrypi.org">raspberry pi</a> has always been appealing to me, but I needed a project to
really get involved. After discussing with <a href="https://github.com/koncina">Eric Koncina</a> who made several
great applications with Pis, I decided to go for a home surveillance system.</p>

<p>The main objective was to see how often the neighbor cats are coming to our garden, because they are scaring our cat. It&rsquo;s not a big deal, rather a justification for the <strong>pi</strong> project.</p>

<h2 id="materials">Materials</h2>

<p>I bought a <a href="https://www.kubii.fr/fr/kits-raspberry-pi/1992-starter-kit-raspberry-pi-3-budget-3272496008496.html">Pi3 starter budget kit</a> that contains:</p>

<ul>
<li>Pi3</li>
<li>power, 5V, 2.5A</li>
<li>case</li>
<li>SD card 16 Go</li>
</ul>

<p>Additionally, I purchased:</p>

<ul>
<li>[Pi camera NoIR]()</li>
</ul>

<p>Was hoping to get some decent pictures / videos with low light. Turned out that IR leds are needed. That goes in the <a href="#todo">TODO</a> section.</p>

<h2 id="setting-up-the-pi">Setting-up the pi</h2>

<p>I won&rsquo;t go into details, I mostly followed the instructions in this <a href="https://howchoo.com/g/ndy1zte2yjn/how-to-set-up-wifi-on-your-raspberry-pi-without-ethernet">tutorial</a>. Briefly, here are the main steps</p>

<h3 id="download-raspbian-lite">download raspbian lite</h3>

<p>Since I have no screen, no keyboard and the pi comes with a wifi controler, the <strong>stretch lite</strong> is sufficient. Image can be found at <a href="https://www.raspberrypi.org/downloads/raspbian/">raspberrypi.org</a></p>

<h3 id="format-sd-card">format SD card</h3>

<p>using disk utility, choose <code>MS-DOS FAT</code> file system</p>

<h3 id="install-raspbian">install raspbian</h3>

<p>Ensure your SD card is the second disk (<code>/dev/disk2</code>), otherwise <strong>do</strong> adapt to the correct one!</p>

<pre><code>unzip 2017-11-29-raspbian-stretch-lite.zip
sudo dd bs=1m if=2017-11-29-raspbian-stretch-lite.img of=/dev/rdisk2
</code></pre>

<h3 id="enable-ssh">enable ssh</h3>

<p>Once copied, you can enable <strong>ssh</strong> by creating an empty file at the SD card root</p>

<pre><code>cd /Volumes/boot/
touch ssh
</code></pre>

<h3 id="enable-wifi">enable wifi</h3>

<p>In order to connect to the pi without screen / keyboard, <strong>wifi</strong> needs to be configured right away. At the same location (<code>/Volumes/boot</code>) add a file named <code>wpa_supplicant.conf</code></p>

<p>which contains:</p>

<pre><code>network={
        ssid=&quot;your_network_ssid&quot;
        psk=&quot;xxx&quot;
        key_mgmt=WPA-PSK
}
</code></pre>

<p>Of note, I recently acquired a pi <strong>zeroWH</strong>, for which I had to add 3 lines ([SO question]()).</p>

<pre><code>ctrl_interface=DIR=/var/run/wpa_supplicant GROUP=netdev
update_config=1
country=FR
network={
        ssid=&quot;your_network_ssid&quot;
        psk=&quot;xxx&quot;
        key_mgmt=WPA-PSK
}
</code></pre>

<h3 id="connect-to-pi">connect to pi</h3>

<p>once the raspberrypi booted, try to find its IP</p>

<pre><code>nmap -sn 192.168.1.0/24
</code></pre>

<p>which gives:</p>

<pre><code>Starting Nmap 7.60 ( https://nmap.org ) at 2017-12-08 22:44 CET
Nmap scan report for 192.168.1.27
Host is up (0.0071s latency).
Nmap scan report for 192.168.1.254
Host is up (0.0048s latency).
Nmap done: 256 IP addresses (2 hosts up) scanned in 11.71 seconds
</code></pre>

<p><code>192.168.1.254</code> was the rooter, so pi was assigned <code>192.168.1.27</code></p>

<p><code>ssh pi@192.168.1.27</code> works.</p>

<p>you can also assign a fixed IP to your pi</p>

<h3 id="final-configuration">final configuration</h3>

<p>once connected to the pi:</p>

<ul>
<li>run <code>sudo raspi-config</code> to activate the camera</li>
<li>change password for the <code>pi</code> user</li>
<li>set up <code>locales</code> and timezone</li>
<li>update &amp;&amp; upgrade raspbian strech</li>
<li>add public <code>ssh</code> key to <code>.ssh/authorized_keys</code> for password less connection</li>
</ul>

<h2 id="install-the-surveillance-system">install the surveillance system</h2>

<p>Even if, I&rsquo;d like to have <a href="https://github.com/opencv">openCV</a> like in this <a href="https://www.pyimagesearch.com/2017/09/04/raspbian-stretch-install-opencv-3-python-on-your-raspberry-pi/">tutorial</a>, it was way more work. Hence, the choice of <a href="https://motion-project.github.io">motion</a></p>

<h3 id="motion-software">motion software</h3>

<p>I followed the instructions provided in this great <a href="https://www.bouvet.no/bouvet-deler/utbrudd/building-a-motion-activated-security-camera-with-the-raspberry-pi-zero">tutorial</a> by <strong>Bouvet</strong>. With some changes described below.</p>

<h4 id="compilation">compilation</h4>

<p>see from here <a href="https://motion-project.github.io/motion_build.html">https://motion-project.github.io/motion_build.html</a></p>

<pre><code>wget https://github.com/Motion-Project/motion/releases/download/release-4.1.1/pi_stretch_motion_4.1.1-1_armhf.deb
sudo apt-get install gdebi-core
sudo gdebi pi_stretch_motion_4.1.1-1_armhf.deb
</code></pre>

<h3 id="run-motion">run <code>motion</code></h3>

<p>first, as <strong>Bouvet</strong> suggested, I copied the main config file</p>

<p><code>mkdir ~/motion &amp;&amp; cp /etc/motion/motion.conf ~/motion/</code></p>

<p>and alter the new copy.</p>

<p>running <strong>motion</strong>:</p>

<p><code>motion -c ~/motion/motion.conf</code></p>

<h3 id="tweaks-to-the-initial-tutorial">tweaks to the initial tutorial</h3>

<p>I choose to get the videos</p>

<p><code>gdiff /etc/motion/motion.conf ~/motion/motion.conf</code></p>

<pre><code>lighswitch 80
auto_brightness on
</code></pre>

<h2 id="communication-between-motion-via-telegram">Communication between motion <em>via</em> telegram</h2>

<p>Now comes the fun part. Receiving the motion detection by emails is fine, but it can be done via <strong>Telegram</strong> and the awesome API <a href="http://telepot.readthedocs.io"><code>telepot</code></a>. <strong>Eric</strong> told me about telegram <strong>bots</strong> and it looked promising.
Actually, you can even <em>send</em> commands to your pi using your phone using those telegram <strong>bots</strong>.</p>

<p>The useful feature I implemented are:</p>

<ul>
<li><strong>alerts</strong>. A motion is detected. Send the best picture to your telegram account.</li>
<li><strong>pause</strong> / <strong>resume</strong> motion detection. Imagine you are away and for some reason (shadows, your own cat) you keep receiving alerts, you may want to remotely <em>pause</em> the dectection. And of course, being able to <em>resume</em> it. Those commands are already in <code>motion</code>, we just need to talk to it.</li>
<li><strong>status</strong>. You haven&rsquo;t received alerts, is the system running smoothly? You can ask for a confirmation that detection is on. Also, check if the camera is on.</li>
<li><strong>snapshot</strong>. No alerts, but you&rsquo;d like to get a snapshot at any time.</li>
<li><strong>video</strong>. Maybe the nicest feature IMHO. Sending picture to your phone for every detection is fine, but not all videos. Based on the picture you see, you&rsquo;d like to get the video of the detection. Once again, by a command to a telegram bot, you receive the last video recorded.</li>
</ul>

<h3 id="create-mybot">create mybot</h3>

<p>Eric gave me the link to this <a href="http://www.instructables.com/id/Set-up-Telegram-Bot-on-Raspberry-Pi/">tutorial</a></p>

<p>Of course, I am assuming you already have our own telegram account.</p>

<p>Talk to the <code>BotFather</code> and create <code>mybot</code>, you will receive a private token.</p>

<h3 id="install-telepot">install telepot</h3>

<p>back on the pi, install <code>telepot</code> with <code>pip</code>, assuming you installed <code>python</code> and <code>pip</code>.</p>

<pre><code>pip install telepot
</code></pre>

<h3 id="test-sending-message">test sending message</h3>

<pre><code class="language-python">import telepot
bot = telepot.Bot('your-token')
bot.getMe()
</code></pre>

<p>returns <code>{u'username': u'mybot', u'first_name': u'cat tracker', u'is_bot': True, u'id': 00000008}</code></p>

<p>to get your telegram id:</p>

<ul>
<li>send a messages from telegram to <code>mybot</code></li>
<li>fetch your message on the pi
<code>
from pprint import pprint
response = bot.getUpdates()
pprint(response)
</code></li>
</ul>

<p>your id appears, such as: <strong>u&rsquo;id&rsquo;: 00000004</strong></p>

<h4 id="basic-tests">basic tests</h4>

<ul>
<li>for text</li>
</ul>

<p><code>bot.sendMessage(00000004, 'Hey!')</code></p>

<ul>
<li>for picture</li>
</ul>

<p><code>bot.sendPhoto(00000004, photo=open('/home/pi/motion/detected/07-2018-01-06_205746-13.jpg', 'rb'), caption='motion detected')</code></p>

<ul>
<li><p>take snapshot on command</p></li>

<li><p>in <code>bash</code>:
<code>curl -s http://localhost:8080/0/action/snapshot &gt; /dev/null</code></p></li>

<li><p>in python:
<code>import requests; requests.get('http://localhost:8080/0/action/snapshot')</code></p></li>

<li><p>disable the join group with botfather</p></li>

<li><p>Commands, after sending <code>/setcommands</code> to the <code>BotFather</code></p></li>
</ul>

<pre><code>time - Returns current time on pi
check - Returns status of the camera
status - Returns status of motion
pause - Pauses the motion detection
resume - Resumes motion detection
snapshot - Returns current image
video - Returns last recorded video
</code></pre>

<h3 id="run-at-startup">run at startup</h3>

<p>in <code>/etc/rc.local</code></p>

<p>add the following lines</p>

<pre><code># start listening to picatbot
/home/pi/motion/telegrambot.sh &amp;
# start motion
motion -c /home/pi/motion/motion.conf
</code></pre>

<h3 id="todo">TODO</h3>

<ul>
<li>change the command line arg of <code>send*py</code> scripts with <code>argparse</code></li>
<li>remove pics/videos older than <em>xx</em> days to save space</li>
<li>run the 2 services as a user without sudo</li>
<li>look into better settings for NoIR using <a href="https://raspberrypi.stackexchange.com/questions/13818/auto-brightness-bypass-whilst-using-motion">this thread</a></li>
</ul>

                </section>
            </article>

            

            
                <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'ginolhac'; 

     
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>

            

            

            <footer id="footer">
    
        <div id="social">

	
	
    <a class="symbol" href="https://github.com/ginolhac">
        <i class="fa fa-github-square"></i>
    </a>
    
    <a class="symbol" href="https://www.linkedin.com/in/aur%c3%a9lien-ginolhac-07b33b92/">
        <i class="fa fa-linkedin-square"></i>
    </a>
    
    <a class="symbol" href="https://twitter.com/kingsushigino">
        <i class="fa fa-twitter-square"></i>
    </a>
    


</div>

    
    <p class="small">
    
       © Copyright 2018 <i class="fa fa-heart" aria-hidden="true"></i> 
    
    </p>
    <p class="small">
        Powered by <a href="http://www.gohugo.io/">Hugo</a> Theme By <a href="https://github.com/nodejh/hugo-theme-cactus-plus">nodejh</a>
    </p>
</footer>

        </section>

        <script src="../../js/jquery-2.2.4.min.js"></script>
<script src="../../js/main.js"></script>
<script src="../../js/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>




  
<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-29962051-1', 'auto');
ga('send', 'pageview');
</script>





    </body>
</html>
